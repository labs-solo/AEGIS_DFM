# 1. Executive Summary

**AEGIS V2 is a holistic liquidity engine for Uniswap V4** that allows any participant—liquidity provider, market-maker, structured-product desk, or trader—to compose deposits, loans, swaps, LP-NFT operations, and price-triggered orders **in a single atomic transaction** while enjoying pool-level risk isolation and deterministic execution. It integrates Uniswap’s liquidity provision, fee management, collateralized lending, advanced LP positions (including on-chain limit orders), and automated liquidations into one unified **Vault** architecture. Each user’s assets and debts are isolated in a per-pool vault (capping the blast radius to a single pair) even as a single global VaultManager contract coordinates all pools network-wide. A robust batch execution engine bundles up to 14 actions (e.g. *add liquidity → borrow → swap to hedge → place limit order*) in one go, guaranteeing that collateral-increasing steps execute before collateral-reducing steps. This design enables users to safely execute complex **DeFi** workflows that would otherwise require multiple protocols and transactions. Additionally, AEGIS V2 introduces share-based lending, whereby liquidity provider shares serve as direct collateral and borrowers repay a fixed share amount (not an unpredictable token amount), simplifying leverage management and enabling seamless **LP collateralization**. It even offers native on-chain limit orders via zero-range liquidity positions with deterministic settlement—unlocking tight spread, automated market-making strategies previously impossible in legacy AMMs.

**One-Transaction Strategies Enabled:**

* **Liquidity Providers (LPs):** Earn Uniswap trading fees on deposited assets *while retaining instant liquidity* (via the ability to borrow against or withdraw from positions at any time).
* **Market Makers:** Quote tight, two-sided markets within a single block, using on-chain limit orders to deploy both bid and ask liquidity with minimal exposure.
* **Structured Product Desks:** Launch delta-neutral yield strategies or other structured products with a single contract call, bundling swaps, liquidity provision, and hedges atomically.
* **Leveraged Traders:** Move from a spot position to a leveraged long or short and even add a hedge **entirely on-chain**, all in one unified margin transaction (no CeFi or multi-protocol hopping required).

### <a id="share-borrow-intro"></a> Share-Based Borrowing & Invariant Accounting
AEGIS V2 serves simultaneously as a liquidity engine and a lending engine. Both collateral and debt are denominated in identical share units. Whitelisted collateral types are full-range shares, idle token collateral, and concentrated LP-NFT collateral. Invariant share pricing offers one yard‑stick for debt and collateral, eliminating price mismatches. Because each share’s value tracks \(\sqrt{a\times b}\), collateral ratios stay meaningful at every tick, while a global borrow index updates every loan in \(O(1)\) gas.

At a high level, AEGIS V2’s architecture centers on an upgradeable **VaultManagerCore** that interfaces with Uniswap v4 pools via a specialized **Spot Hook**, supported by modular components for dynamic fees, interest rates, pricing oracles, and risk policy. All user operations flow through a stateless batch router into the VaultManager, which in turn manages liquidity positions (minting or burning Uniswap LP tokens) and enforces margin rules and liquidations in real time. This layered design ensures no pool can contaminate another’s solvency, and new collateral types or actions can be added without disruptive migrations. *(See Appendix A for a detailed architecture diagram and component overview.)*
