## Appendix G — Invariant Catalog and Status

The table below presents a **unified catalog of all invariants** in the AEGIS V2 system, along with their subsystem grouping, introduction milestone, enforcement point, and current status. This is intended as a quick-reference for auditors and developers. (Status Legend: **Active** – enforced in current code; **Folded** – merged into another invariant or design assumption; **Obsolete** – no longer applicable in current code.)

### Scope
- `simulateBatchTyped` is read-only; invariant checks run but **no storage mutates**. (See INV‑2.3 Pending Fees Cleared.)

| **Tag** | **Invariant Description** | **Why it matters** | **Subsystem** | **Introduced** | **Enforcement Point** (Contract.Function) | **Status** |
| --- | --- | --- | --- | --- | --- | --- |
| **INV-2.1**    | — | **Total Shares ≥ Locked** – Total pool shares never falls below the immutable `lockedShares` minimum. Prevents draining pool to 0 liquidity. | Liquidity (Share Supply) | —              | VaultManagerCore – enforced via withdrawal logic (no user can withdraw locked portion)                                                                                   | **Active**        |
| **INV-2.2**    | — | **Locked Shares Never Decrease** – Once set on first deposit, the `lockedShares` amount is never reduced.                                    | Liquidity (Share Supply) | —              | VaultManagerCore – `lockedShares` set in `registerPool` (no function to decrease it)                                                                                     | **Active**        |
| **INV-2.3**    | — | **Pending Fees Cleared on Reinvest** – After fees are reinvested, pending fee counters reset to zero (no lingering fee balances).            | Fees & Reinvestment      | —              | VaultManagerCore.`reinvestFees(pool)` – resets `pendingFees[pool]` to 0 on success                                                                                       | **Active**        |
| **INV-2.4**    | — | **Fee Counters Monotonic** – Pending fee accumulators only increase (fees never spontaneously decrease unless converted to shares).          | Fees & Reinvestment      | —              | SpotHook / VaultManager – `notifyFees` only increments counters (no decrements)                                                                                          | **Active**        |
| **INV-2.5**    | — | **Share Price Non-Decreasing** – see [Lemma 5.2-A](../05_Functional_Specs.md#lemma-5-2-a) | Liquidity (Share Value)  | —              | VaultManagerCore – enforced by proportional mint/burn on reinvest & withdraw (design invariant) | **Active**        |
| **INV-2.6**    | — | **Authorized Hook Only** – Only the authorized Uniswap V4 hook (Spot) or router can call vault liquidity functions (deposit/withdraw).       | Access Control           | —              | VaultManagerCore.`deposit/withdraw` – `require(msg.sender == authorizedHook)`                                                                                            | **Active**        |
| **INV-2.7**    | — | **Emergency Pause Halts Ops** – When paused (global or per-pool), disallow deposits, withdrawals, and other risky actions.                   | Access Control           | —              | VaultManagerCore – `whenNotPaused` modifiers on functions; Spot – checks `emergencyState`                                                                                | **Active**        |
| **INV-3.1**    | — | **Borrow Index Monotonic** – Borrow interest index (`shareIndex`) never decreases; interest only accumulates or stays flat.                  | Lending (Interest)       | —              | VaultManagerCore.`accrueInterest` – index updated multiplicatively (non-decreasing)                                                                                      | **Active**        |
| **INV-3.2**    | — | **Accrual Time Consistent** – `lastAccrueTime` always ≤ current time (no future timestamp) and updates in-order.                             | Lending (Interest)       | —              | VaultManagerCore.`accrueInterest` – skips if `block.timestamp` <= lastAccrueTime; sets lastAccrueTime = now                                                              | **Active**        |
| **INV-3.3 (INV-BOR-01)** | **Global Solvency** – Total borrowed shares in a pool ≤ total share supply. | Prevents pool from lending nonexistent liquidity. | Lending (Solvency) | — | VaultManagerCore – enforced by burning shares on borrow (maintains `totalBorrowShares <= totalShares`) | **Active** |
| **INV-3.4 (INV-COL-02)** | **Per-User Solvency** – Each user's debt ≤ collateral * maint. factor; no account can become under-collateralized without liquidation. | Keeps each account solvent relative to collateral. | Lending (Solvency) | — | VaultManagerCore.`borrowShares` – collateral factor require checks; VaultManagerCore.`withdraw` – `_checkSolvency` on pull-out (reverts if debt would exceed collateral) | **Active** |
| **INV-3.5**    | — | **Collateral Factor Bounds** – Initial collateral factor ≤ maintenance factor ≤ 100%. Ensures risk params are logically ordered.             | Risk Parameters          | —              | PoolPolicyManager.`setCollateralFactors` – require initBps <= maintBps <= 10000                                                                                          | **Active**        |
| **INV-3.6**    | — | **Borrow Increases Debt** – Calling `borrowShares` increases the user's and system's debt counters exactly by the borrowed amount.           | Accounting (Debt)        | —              | VaultManagerCore.`borrowShares` – increments `userVault.borrowShares` and `totalBorrowShares` by `shares`                                                                | **Active**        |
| **INV-3.7**    | — | **Repay Reduces Debt** – Calling `repayShares` decreases the user's and system's debt counters exactly by the repaid amount.                 | Accounting (Debt)        | —              | VaultManagerCore.`repayShares` – decrements `borrowShares` and `totalBorrowShares` by `shares` repaid                                                                    | **Active**        |
| **INV-3.8**    | — | **ShareMultiplier Monotone** – Global `shareMultiplier` never decreases. | Interest Accrual | draft | accrueInterest() | **Draft** |
| **INV-WCLedger** | — | **Worst‑Case Ledger** – NetA ≥ WorstA && NetB ≥ WorstB. | Collateral Accounting | draft | mintCR/burnCR/LO fill | **Draft** |
| **INV-UtilCap** | — | **Utilisation Cap** – Utilisation U ≤ 0.95. | Lending Limits | active | borrowFR, repayFR, accrueInterest() | **Active** |
| **INV-LIM-01** | — | **Limit Order = Single Tick** – Limit orders are represented as one-tick-wide LP positions (no multi-tick range allowed for limit orders).   | Trading (Limit Orders)   | —              | VaultManagerCore.`openLPPosition` – for limit orders, uses `tickLower == tickUpper` (enforced in function params)                                                        | **Active**        |
| *INV-9.1*      | — | — | — | — | — | *(Paused State Halts Risky Actions – legacy draft label for pause invariant, now INV-2.7)*                                                   | *Access Control*         | *—*            | *See INV-2.7 (Unified)*                                                                                                                                                  | *Folded*          |
| *INV-9.2*      | — | — | — | — | *(Timelock on Critical Gov Actions – off-chain policy to delay governance changes)*                                                          | *Governance*             | *—*            | *Off-chain via Timelock contract (48h delay)*                                                                                                                            | *Active (policy)* |
| *INV-9.3*      | — | — | — | — | *(Module Upgrade Safety – new modules must be compatible with storage/interfaces)*                                                           | *Upgradability*          | *—*            | *Governance review + interface checks on setModule (OZ's `supportsInterface`)*                                                                                           | *Active*          |
| *INV-9.4*      | — | — | — | — | *(No Unbounded Loops – all on-chain loops are bounded by design)*                                                                            | *Architecture*           | *—*            | *Code structure – no user-iterating loops (e.g. liquidations handled per-user)*                                                                                          | *Active*          |

**Notes:** Legacy tags INV-9.x refer to the draft spec numbering and are included for historical reference; they have been integrated into the INV-2.x/3.x set or addressed via off-chain mechanisms. All active invariants above are enforced in the deployed contracts. The system's continuous testing (see §8.4) exercises these invariants across all features (earlier draft iterations), ensuring none are violated in any valid operation sequence.
